<!DOCTYPE html>
<html lang="pt-br">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Teste R√°pido - Chrome</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                max-width: 800px;
                margin: 20px auto;
                padding: 20px;
            }
            button {
                padding: 10px 20px;
                margin: 10px;
                background: #007bff;
                color: white;
                border: none;
                border-radius: 5px;
                cursor: pointer;
            }
            .result {
                margin: 10px 0;
                padding: 15px;
                border-radius: 5px;
            }
            .success {
                background: #d4edda;
                color: #155724;
            }
            .error {
                background: #f8d7da;
                color: #721c24;
            }
            pre {
                background: #f8f9fa;
                padding: 10px;
                border-radius: 4px;
                font-size: 12px;
                overflow-x: auto;
            }
        </style>
    </head>
    <body>
        <h1>üöÄ Teste R√°pido - Dashboard SysMed</h1>

        <div>
            <button onclick="configurarAdmin()">
                1. üîê Login Real (Admin)
            </button>
            <button onclick="testarDashboard()">2. üìä Testar Dashboard</button>
            <button onclick="abrirDashboard()">3. üåê Abrir Dashboard</button>
            <button onclick="limparTudo()">üóëÔ∏è Limpar</button>
        </div>

        <div id="resultado"></div>

        <script>
            function log(message, type = "info") {
                const div = document.createElement("div");
                div.className = `result ${type}`;
                div.innerHTML = message;
                document.getElementById("resultado").appendChild(div);
            }

            async function configurarAdmin() {
                log("üîÑ Fazendo login real...", "info");

                try {
                    const response = await fetch(
                        "http://localhost:8000/api/login",
                        {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                Accept: "application/json",
                            },
                            body: JSON.stringify({
                                email: "admin@sysmed.com",
                                password: "senha123",
                            }),
                        }
                    );

                    const data = await response.json();

                    if (response.ok && data.success) {
                        const user = data.data.user;
                        const token = data.data.token;

                        // Salvar no localStorage
                        localStorage.setItem("authToken", token);
                        localStorage.setItem("userName", user.name);
                        localStorage.setItem("userRole", user.role || "admin");
                        localStorage.setItem("userEmail", user.email);
                        localStorage.setItem("user", JSON.stringify(user));

                        log(
                            `‚úÖ Login realizado com sucesso!<br>
                             Usu√°rio: ${user.name}<br>
                             Token: ${token.substring(0, 25)}...`,
                            "success"
                        );
                    } else {
                        log(`‚ùå Erro no login: ${data.message}`, "error");
                    }
                } catch (error) {
                    log(
                        `‚ùå Erro de conex√£o: ${error.message}<br>
                         üí° Verifique se o servidor Laravel est√° rodando`,
                        "error"
                    );
                }
            }

            async function testarDashboard() {
                const token = localStorage.getItem("authToken");

                if (!token) {
                    log("‚ùå Fa√ßa login primeiro!", "error");
                    return;
                }

                log("üîÑ Testando dashboard...");

                try {
                    const response = await fetch(
                        "http://localhost:8000/api/dashboard/statistics",
                        {
                            method: "GET",
                            headers: {
                                Authorization: `Bearer ${token}`,
                                Accept: "application/json",
                                "Content-Type": "application/json",
                            },
                        }
                    );

                    log(`üì° Status: ${response.status}`);

                    if (response.ok) {
                        const data = await response.json();

                        if (data.success) {
                            log(
                                `‚úÖ Dashboard funcionando!<br>
                            üìà Pacientes: ${data.data.overview.totalPatients}<br>
                            üìÖ Consultas hoje: ${data.data.overview.appointmentsToday}<br>
                            üìä Consultas semana: ${data.data.overview.appointmentsThisWeek}`,
                                "success"
                            );

                            log(
                                "<details><summary>Ver dados completos</summary><pre>" +
                                    JSON.stringify(data, null, 2) +
                                    "</pre></details>"
                            );
                        } else {
                            log(
                                "‚ùå Resposta indica erro: " +
                                    (data.message || "Erro desconhecido"),
                                "error"
                            );
                        }
                    } else {
                        const errorText = await response.text();
                        log(
                            `‚ùå Erro HTTP ${response.status}: ${response.statusText}<br>` +
                                `Resposta: ${errorText}`,
                            "error"
                        );
                    }
                } catch (error) {
                    log(
                        `‚ùå Erro de conex√£o: ${error.message}<br>` +
                            `üí° Verifique se o servidor Laravel est√° rodando em http://localhost:8000`,
                        "error"
                    );
                }
            }

            function abrirDashboard() {
                const url = "http://localhost:5175/";
                window.open(url, "_blank");
                log(`üåê Dashboard aberto em nova aba: ${url}`, "success");
            }

            function limparTudo() {
                localStorage.clear();
                document.getElementById("resultado").innerHTML = "";
                log("üóëÔ∏è Tudo limpo!", "success");
            }

            // Verificar status ao carregar
            window.onload = function () {
                const token = localStorage.getItem("authToken");
                const user = localStorage.getItem("userName");

                if (token && user) {
                    log(
                        `‚ÑπÔ∏è Usu√°rio logado: ${user}<br>Token: ${token.substring(
                            0,
                            25
                        )}...`,
                        "info"
                    );
                } else {
                    log(
                        '‚ÑπÔ∏è Nenhum usu√°rio logado. Clique em "Login Admin" para come√ßar.',
                        "info"
                    );
                }
            };
        </script>
    </body>
</html>
